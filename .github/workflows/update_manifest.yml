name: Release Build and Manifest Update

on:
  # Löst den Workflow aus, wenn ein Release veröffentlicht wird
  release:
    types: [published]

jobs:
  build_and_update_manifest:
    runs-on: ubuntu-latest
    
    # NEU: Das GITHUB_TOKEN braucht keine Schreibrechte mehr für Commits,
    # da wir nur die Version für den Build-Schritt anpassen.
    permissions:
      contents: read 

    steps:
      # 1. Repository auschecken (Der Code am Tag/Release-Punkt wird geholt)
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Versionsnummer aus dem Release-Tag extrahieren und bereinigen
      - name: Extract and Clean Version from Release Tag
        id: get_version
        run: |
          # ${{ github.event.release.tag_name }} enthält den Tag (z.B. "v_1.3")
          TAG_VERSION=${{ github.event.release.tag_name }}
          
          # Entfernt 'v_' (z.B. v_1.3 wird zu 1.3)
          CLEAN_VERSION=$(echo "$TAG_VERSION" | sed 's/^v_//')
          
          echo "CURRENT_VERSION=${CLEAN_VERSION}" >> $GITHUB_ENV
          echo "Building Release for Version: ${{ env.CURRENT_VERSION }}"

      # 3. Manifest.json aktualisieren (DIESER SCHRITT ÄNDERT NUR DIE LOKALE KOPIE)
      - name: Update manifest.json for Build
        run: |
          MANIFEST_PATH=custom_components/victron_vrm_api/manifest.json
          # Ersetze die Versionszeile
          sed -i 's@"version": ".*"@"version": "${{ env.CURRENT_VERSION }}"@g' "$MANIFEST_PATH"
          echo "manifest.json wurde lokal für den Build aktualisiert."

      # 4. ZIP-Datei/Release-Asset erstellen (Ihr Build-Schritt)
      # Hier packen Sie das gesamte Verzeichnis (das jetzt die korrigierte manifest.json enthält)
      - name: Create Release Archive
        run: |
          # Beispiel: Erstellt ein ZIP-Archiv des gesamten Repositories
          zip -r victron_vrm_api_release_${{ env.CURRENT_VERSION }}.zip custom_components/victron_vrm_api

      # 5. Asset an den Release anhängen
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./victron_vrm_api_release_${{ env.CURRENT_VERSION }}.zip
          asset_name: victron_vrm_api_release_${{ env.CURRENT_VERSION }}.zip
          asset_content_type: application/zip
    
