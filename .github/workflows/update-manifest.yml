name: Update Manifest Version from Git Tag (Victron VRM)

on:
  # Führt den Workflow aus, wenn ein neuer Tag erstellt wird, der mit 'v_' beginnt
  push:
    tags:
      - 'v_*'
  workflow_dispatch:

jobs:
  update_version:
    runs-on: ubuntu-latest
    
    # NEU: Setzt die Berechtigungen, um den Push zu erlauben
    permissions:
      contents: write

    steps:
      # 1. Repository auschecken
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Versionsnummer aus dem Git-Tag extrahieren und das Präfix 'v_' entfernen
      - name: Extract and Clean Version from Git Tag
        id: get_tag_version
        run: |
          TAG_VERSION=${{ github.ref_name }}
          # Entfernt das 'v_' am Anfang des Tags (z.B. v_1.2 wird zu 1.2)
          CLEAN_VERSION=$(echo "$TAG_VERSION" | sed 's/^v_//') 
          
          echo "CURRENT_VERSION=${CLEAN_VERSION}" >> $GITHUB_ENV

      # 3. Manifest.json aktualisieren
      - name: Update manifest.json with new version
        run: |
          MANIFEST_PATH=custom_components/victron_vrm_api/manifest.json
          # Ersetze die Versionszeile
          sed -i 's@"version": ".*"@"version": "${{ env.CURRENT_VERSION }}"@g' "$MANIFEST_PATH"

      # 4. Aktualisierte Datei committen und pushen (Syntax korrigiert)
      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: '⚙️ CI: Update version in manifest.json to ${{ env.CURRENT_VERSION }}'
          # NEU: Die zu commitenden Dateien werden über 'file_pattern' angegeben
          file_pattern: custom_components/victron_vrm_api/manifest.json 
          # Das 'token' Input wird entfernt, da wir die Permissions oben gesetzt haben.
